"use strict";function e(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))}class t{constructor(e){const t=document.querySelector(e);if(!t)throw new Error(`DOM elements not found, id=${e}`);this._textAreaElement=t,this._textAreaElement.value="",this._lines=[],this._maxLines=30}log(...e){if(0==e.length)return;const t=Array.prototype.slice.call(e).join(" ");console.log(t),this._pushText(t)}error(...e){if(0==e.length)return;const t=Array.prototype.slice.call(e).join(" ");console.error(t),this._pushText(`[ERR] - ${t}`)}_pushText(e){this._lines.push(e),this._lines.length>this._maxLines&&this._lines.splice(0,this._lines.length-this._maxLines),this._textAreaElement.value=`${this._lines.join("\n")}\n`,this._textAreaElement.scrollTop=this._textAreaElement.scrollHeight}get size(){return this._lines.length}peekLast(){if(this._lines.length>0)return this._lines[this._lines.length-1]}popLast(){this._lines.length>0&&this._lines.splice(this._lines.length-1,1)}}const s=/[?&]+([^=&]+)=([^&]*)/gi;class i{constructor(e,t,s){this._width=800,this._height=600,this._isInitialised=!1,this._isAborted=!1,this._canvas=e,this._onProgress=t,this._onError=s}initialise(t,s,i,n,r){return e(this,void 0,void 0,(function*(){if(this._width=t,this._height=s,!window.Worker)throw new Error("missing WebWorker feature (unsuported)");if(r.log("[JS][check] WebWorker feature => supported"),!(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})())throw new Error("missing WebAssembly feature (unsuported)");r.log("[JS][check] WebAssembly feature => supported");const e=(()=>{const e=void 0!==window.SharedArrayBuffer;if(e){const e=8,t={initial:e,maximum:e,shared:!0};if(!(new WebAssembly.Memory(t).buffer instanceof SharedArrayBuffer))return!1}return e})();if(e?r.log("[JS][check] multithreading => supported"):(r.log("[JS][check] multithreading => NOT supported"),r.log("[JS][check] => falling back to the webworker version")),!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsuported)");r.log("[JS][check] WebGL2 feature => supported");this._canvas.addEventListener("webglcontextcreationerror",(()=>{this._isAborted=!0,this._onError&&this._onError("Could not create a WebGL2 context.")}),!1);this._canvas.addEventListener("webglcontextlost",(()=>{this._isAborted=!0,this._onError&&this._onError("WebGL2 context lost. You will need to reload the page.")}),!1);this._canvas.addEventListener("contextmenu",(e=>{e.preventDefault()}),!1),this._webglCtx=(e=>{if(!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsuported)");const t=e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1});if(!t)throw new Error("WebGL2 context failed (initialisation)");return t})(this._canvas),r.log("[JS] WebGL2 context initialised");const o="wasm/"+(e?"pthread":"webworker");return new Promise(((e,t)=>{const s={downloadingDataRegExp:/Downloading data\.\.\. \(([0-9]*)\/([0-9]*)\)/,lastProgressLevel:0,locateFile:e=>`${o}/${e}`,print:e=>{r.log(`[C++][out] ${e}`)},printErr:e=>{r.error(`[C++][err] ${e}`)},setStatus:e=>{if(!e)return;const t=s.downloadingDataRegExp.exec(e);if(t){const e=parseFloat(t[1]),i=parseFloat(t[2]),n=Math.floor(e/i*100);s.lastProgressLevel!==n&&(s.lastProgressLevel=n,this._onProgress(n))}else r.log(`[JS][wasm][status] ${e}`)},onRuntimeInitialized:()=>{r.log("[JS][wasm] loaded"),r.log("[JS][wasm] initialising");const t={startDemo:window.Module.cwrap("startDemo",void 0,["number","number","number","number"]),updateDemo:window.Module.cwrap("updateDemo",void 0,["number"])};this._wasmDemoUpdateFunc=t.updateDemo,t.startDemo(this._width,this._height,i,n),this._isInitialised=!0,r.log("[JS][wasm] initialised"),e()},canvas:this._canvas,preinitializedWebGLContext:this._webglCtx,noInitialRun:!0,noExitRuntime:!0};var a;window.Module=s,r.log("[JS][wasm] loading"),(a=`./${o}/index.js`,new Promise(((e,t)=>{const s=document.createElement("script");s.src=a,s.addEventListener("load",(()=>e)),s.addEventListener("error",t),document.head.appendChild(s)}))).catch(t)}))}))}update(e){this._isInitialised&&!this._isAborted&&this._wasmDemoUpdateFunc&&this._wasmDemoUpdateFunc(e)}abort(){if(!this._isInitialised||this._isAborted)return;this._isAborted=!0;const e=window.Module;e&&(e.setStatus=e=>{e&&console.error(`[JS][wasm][aborted] ${e}`)})}}window.addEventListener("load",(()=>e(void 0,void 0,void 0,(function*(){let e=!0;const n=new t("#loggerOutput");n.log("[JS] page loaded");const r=t=>{e=!1,n.error(`[JS] exception, event=${t}`)};window.addEventListener("error",r);const o=document.querySelector("#errorText"),a=document.querySelector("#renderArea"),l=document.querySelector("#canvas"),c={switchTo90cars:document.querySelector("#try_with_90_cars"),switchTo270cars:document.querySelector("#try_with_270_cars")},d=e=>{"none"!==e.style.display&&(e.style.display="none")},h=e=>{"block"!==e.style.display&&(e.style.display="block")},u=e=>{o.innerHTML=e,d(l),h(o)};window.removeEventListener("error",r),window.addEventListener("error",(e=>{r(e),u(`fatal error, event=${e}`)}));const w=(e,t)=>e?parseInt(e,10):t,m=(()=>{const e={};let t=null;for(;t=s.exec(window.location.href);){const s=t[1],i=t[2];e[s]=i}return e})(),g={width:w(m.width,800),height:w(m.height,600),totalCores:w(m.totalCores,3),genomesPerCore:w(m.genomesPerCore,30)};var p,f;p=g.width,f=g.height,a.style.width=`${p}px`,a.style.height=`${f}px`,l.width=p,l.height=f,l.style.width=`${p}px`,l.style.height=`${f}px`;const _=(e,t,s)=>{e.disabled=!1,e.classList.contains(t)||e.classList.add(t),e.classList.contains("grayButton")&&e.classList.remove("grayButton"),e.addEventListener("click",(()=>{window.location.href=window.location.pathname+`?genomesPerCore=${s}`}))};30!=g.genomesPerCore?(c.switchTo270cars.disabled=!0,_(c.switchTo90cars,"blueButton",30)):(c.switchTo90cars.disabled=!0,_(c.switchTo270cars,"redButton",90));const b=new i(l,(e=>{const t=`Loading wasm [${e}%]`;n.size>0&&n.peekLast().indexOf("Loading wasm [")>=0&&n.popLast(),n.log(`[JS] ${t}`),u(t)}),u);try{yield b.initialise(g.width,g.height,g.totalCores,g.genomesPerCore,n),d(o),h(l)}catch(e){n.error(`[JS] dependencies check failed: message="${e.message}"`),u(`\n      this browser isn't compatible<br>\n      error message:<br>\n      => ${e.message}\n    `)}const y=Math.floor(1e3/30),v=()=>{e&&setTimeout(v,y),b.update(y)};v()}))));
